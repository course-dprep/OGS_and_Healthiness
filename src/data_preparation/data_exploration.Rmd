---
title: "Data exploration of grocery purchase data"
output: pdf_document
---

```{r, load_packages, include=FALSE, message=FALSE, warning=FALSE}
library(data.table)
library(dplyr)
library(tidyr)
library(tinytex)
library(xtable)
```


```{r, project_setup, include=FALSE, message=FALSE, warning=FALSE}
# creating directory for project

# set wd to home as basis for project storage
setwd("~")

# create directory to save project
dir.create("./online-groceries-impact-healthiness")
setwd("./online-groceries-impact-healthiness")

# create sub-directories
dir.create("data")
dir.create("gen")
dir.create("gen/data-preparation")
dir.create("gen/analysis")
dir.create("gen/paper")
dir.create("src")
dir.create("src/data-preparation")
dir.create("src/analysis")
dir.create("src/paper")

# installing and loading required R packages

required_packages <- c("data.table", "dplyr", "xtable", "tinytex", "ggplot2")

# Install missing packages
installed_packages <- rownames(installed.packages())
for (pkg in required_packages) {
  if (!pkg %in% installed_packages) 
    {install.packages(pkg, dependencies = TRUE)}
}

# Load the packages
lapply(required_packages, library, character.only = TRUE)

rm(pkg, installed_packages, required_packages)
```



```{r import_data, project_setup, include=FALSE, message=FALSE, warning=FALSE}
setwd("~/online-groceries-impact-healthiness")

# download data
download.file("https://raw.githubusercontent.com/course-dprep/online-groceries-impact-healthiness/refs/heads/main/data/dataset_dprep.csv", "~/online-groceries-impact-healthiness/data/dataset_dprep.csv")

DT <- fread("~/online-groceries-impact-healthiness/data/dataset_dprep.csv")
```

## Introduction

This study aims to analyse the impact of households' adoption to online grocery shopping channels on the healthiness of their total (online & offline) grocery purchases. This report serves to provide information on the dataset (i.e. data structure and key variables) and will present several summary statistics to enhance understanding of the data.

The dataset used for this project takes form of panel data time series that captures detailed purchasing behavior at the household and retailer level for the year 2019 in the Netherlands. Each row represents a specific product purchased by a unique household on a given date, providing insights into individual consumption patterns over time. Key variables include the date of purchase, household and retailer identifier, and product details, such as barcode, quantity purchased and price. The panel structure allows for tracking changes in purchasing habits, retailer preferences, and product choices across time. 

Note that the original dataset contains 15 variable, but not every one of those is relevant for this study. In de data preparation phase I will trim and recode the dataset in such a way that best allows for analysis of the study. The table below presents a brief description of the variables relevant for this study.

```{r, echo=FALSE, results='asis'}
variable_table <- data.frame(
  Variable = c("Panelist", "Date of purchase", "Barcode", "Retailer", "Brand", 
               "Total unit sales", "Total value sales", "Total volume sales", 
               "Purchase method", "category", "Measurement unit", 
               "Volume per unit", "segment"),
  Description = c(
    "Unique identifier for each household",
    "Date on which the purchase was made",
    "Barcode of the product purchased",
    "Numeric indicator of the supermarket at which the purchase was made",
    "The brand of the product",
    "Total units of the product sold",
    "Total value of the sales for the product (in Euro cents)",
    "Total volume of the product sold",
    "Method of purchase (i.e. offline or online)",
    "Category indicator to group products (e.g. vegetables)",
    "The unit at which the volume of a product is measured",
    "The volume per unit",
    "A generalized category indicator, based on the 'category' variable"))
    
# Print table with xtable
print(xtable(variable_table, caption = "Description of variables in dataset"), 
      comment = FALSE, 
      include.rownames = FALSE, 
      caption.placement = "bottom")

```
\newpage

## Dataset structure
This research is focused on distribution of purchases by the online and offline channel. The dataset contains purchase data of 150 unique households in the Netherlands in 2019. These households made over 180.000 individual product purchases across 26 different retailers. Table 2 below summarizes some key metrics from the dataset. Out of the 150 households in the panel, 26 have purchased online at least once in 2019. These 26 households combine for just over 6000 online purchases, meaning that approximately 3% of the purchases is made online. The 'online households' are the households of interest for this study, and will serve as the treated group in the difference-in-differences analysis I will perform later on.
 

```{r, echo=FALSE, results='asis'}
summary_table <- data.frame(
  Metric = c("Number of Households", "Number of Retailers", "Number of Purchases"),
  Count = c(length(unique(DT$Panelist)), length(unique(DT$Retailer)), nrow(DT)))

print(xtable(summary_table, caption = "Summary structure dataset"), 
      comment = FALSE, 
      include.rownames = FALSE, 
      caption.placement = "bottom")
```

## Basket summary statistics

In this project I will aggregate the data to the basket level and eventually look at weekly purchases. The table below presents some general basket summary statistics. As can be seen, households purchase on average 10 products during a shopping trip and spend on average 22 euros per trip. 


```{r, include = FALSE}
DT$Total_unit_sales <- as.numeric(DT$Total_unit_sales)

baskets <- DT %>% 
  group_by(Panelist, Date_of_purchase, Retailer) %>%
  summarise(
    basket_size = n(),
    expenditure = sum(Total_value_sales),
    volume = sum(Total_volume_sales)
  ) %>%
  ungroup()
```


```{r, echo=FALSE, results='asis'}
summary_stats <- baskets %>%
  summarise(
    "Mean basket size" = mean(basket_size, na.rm = TRUE),
    "Mean expenditure (Euro)" = mean(expenditure, na.rm = TRUE) / 100,
    "Mean volume (gram)" = mean(volume, na.rm = TRUE)
  )

print(summary_xtable <- xtable(summary_stats, caption = "Summary Statistics of Average Basket Size, Expenditure, and Volume"), 
      comment = FALSE, 
      include.rownames = FALSE, 
      caption.placement = "bottom")
```





### Sales across retailers

Before diving into the specifics of the purchased products, it is important to in broad terms where and how the household make their purchases. Figure 1 below shows an overview of the total expenditure per retailer. It becomes evident that there are 3 rather dominant retailers: Retailer 4, Retailer 15 and Retailer 17. These retailers combine for nearly 60% of the total expenditure. 

```{r, echo=FALSE, results='asis'}
retailer_sales <- DT %>%
  group_by(Retailer) %>%
  summarise(total_value_sales = sum(Total_value_sales) /100) %>%
  mutate(
    percentage_sales = (total_value_sales / sum(total_value_sales)) * 100  )

ggplot(DT, aes(x = factor(Retailer), y = (`Total_value_sales` / 100))) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(
    title = "Total value of sales by retailer (Euro)", 
    x = "Retailer", 
    y = "Value sales",
    caption = "Figure 1: The distribution of total value sales across different retailers") +
  theme_minimal() +
  theme(    plot.caption = element_text(hjust = 0.5) )
```






